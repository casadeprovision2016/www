# üèóÔ∏è Plano Arquitetural Full-Stack - CCCP (Casa de Provis√£o)

## üìã Arquitetura Proposta

**Stack Tecnol√≥gica**
- **Frontend:** React 18 + TypeScript + Vite + ShadCN + Tailwind
- **Backend API:** Node.js + Express + TypeScript
- **Database:** Supabase Database (BaaS)
- **Storage:** Supabase Storage
- **Auth:** Supabase Auth + JWT
- **Cache:** Redis (Upstash Cloud - Free Tier)
- **Deploy:** Docker + Cloudflare Tunnel

## üíª Tecnologias e Servi√ßos

Esta secci√≥n detalla las principales tecnolog√≠as y servicios utilizados en el proyecto, explicando el prop√≥sito de cada uno.

- **[React 18](https://react.dev/)**: Biblioteca para construir interfaces de usu√°rio com componentes reutiliz√°veis e eficientes.
- **[TypeScript](https://www.typescriptlang.org/docs/)**: Superset de JavaScript que a√±ade tipado est√°tico, mejorando la mantenibilidad y la detecci√≥n de errores.
- **[Vite](https://vitejs.dev/guide/)**: Ferramenta de build moderna que oferece um desenvolvimento r√°pido com Hot Module Replacement (HMR).
- **[ShadCN/UI](https://ui.shadcn.com/docs)**: Colecci√≥n de componentes de UI reutilizables y accesibles, construidos sobre Tailwind CSS y Radix UI.
- **[Tailwind CSS](https://tailwindcss.com/docs)**: Framework CSS utility-first para criar designs customizados rapidamente sem sair do HTML.
- **[Node.js](https://nodejs.org/en/docs/)**: Entorno de ejecuci√≥n JavaScript en el servidor, permitiendo la construcci√≥n de APIs r√°pidas y escalables.
- **[Express](https://expressjs.com/)**: Framework minimalista para Node.js, usado para criar a estrutura da API RESTful.
- **[Supabase](https://supabase.com/docs)**: Plataforma Backend-as-a-Service (BaaS) que oferece banco de dados PostgreSQL, autentica√ß√£o, storage e APIs auto-geradas.
  - **[Database](https://supabase.com/docs/guides/database/overview/)**: Banco de dados relacional robusto e escal√°vel.
  - **[Supabase Auth](https://supabase.com/docs/guides/auth)**: Gerencia a autentica√ß√£o de usu√°rios com JWT e integra√ß√£o com RLS.
  - **[Supabase Storage](https://supabase.com/docs/guides/storage)**: Armazena arquivos como imagens de perfil e comprovantes de doa√ß√£o.
- **[Redis (Upstash)](https://upstash.com/docs/redis)**: Banco de dados em mem√≥ria usado para cache de alta performance, reduzindo a carga no banco de dados principal.
- **[Docker](https://docs.docker.com/)**: Plataforma de containeriza√ß√£o para empacotar e distribuir a aplica√ß√£o de forma consistente em diferentes ambientes.
- **[Cloudflare Tunnel](https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/)**: Cria um t√∫nel seguro entre o servidor local e a rede da Cloudflare, permitindo a exposi√ß√£o da aplica√ß√£o na internet sem IP p√∫blico.
- **[Zod](https://zod.dev/)**: Biblioteca de valida√ß√£o de schemas para garantir a integridade dos dados que entram na API.
- **[DOMPurify](https://github.com/cure53/DOMPurify)**: Sanitizador de HTML para prevenir ataques de XSS ao lidar com conte√∫do gerado pelo usu√°rio.
- **[Multer](https://github.com/expressjs/multer)**: Middleware para Node.js que facilita o upload de arquivos.
- **[Sharp](https://sharp.pixelplumbing.com/)**: Biblioteca de processamento de imagens de alta performance para Node.js.
- **[Winston](https://github.com/winstonjs/winston)**: Biblioteca de logging para registrar eventos e erros da aplica√ß√£o de forma estruturada.
- **[node-cron](https://github.com/node-cron/node-cron)**: Agendador de tarefas para executar rotinas em segundo plano, como backups e relat√≥rios.

## üê≥ Estrutura Docker

Arquivo: `docker-compose.yml`
```yaml
version: '3.8'
services:
  # Frontend React + Vite
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - VITE_API_URL=http://api:4000
      - VITE_SUPABASE_URL=${VITE_SUPABASE_URL}
      - VITE_SUPABASE_ANON_KEY=${VITE_SUPABASE_ANON_KEY}
    depends_on:
      - api
    networks:
      - cccp-network

  # Backend API Node.js
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    ports:
      - "4000:4000"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=${DATABASE_URL}
      - SUPABASE_URL=${VITE_SUPABASE_URL}
      - SUPABASE_ANON_KEY=${VITE_SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - REDIS_URL=${REDIS_URL}
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      - cron-jobs
    networks:
      - cccp-network

  # Background Jobs & Cron
  cron-jobs:
    build:
      context: ./api
      dockerfile: Dockerfile.worker
    environment:
      - NODE_ENV=production
      - DATABASE_URL=${DATABASE_URL}
      - SUPABASE_URL=${VITE_SUPABASE_URL}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - REDIS_URL=${REDIS_URL}
    networks:
      - cccp-network

  # Cloudflare Tunnel
  cloudflare-tunnel:
    image: cloudflare/cloudflared:latest
    command: tunnel --no-autoupdate run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    depends_on:
      - frontend
    networks:
      - cccp-network

networks:
  cccp-network:
    driver: bridge
```

## üìÅ Estrutura de Diretorios

```
cccp/
‚îú‚îÄ‚îÄ frontend/
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îî‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile.worker
‚îÇ   ‚îî‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ shared/
‚îÇ   ‚îî‚îÄ‚îÄ types/
‚îú‚îÄ‚îÄ docker-compose.yml
‚îú‚îÄ‚îÄ .env.production
‚îî‚îÄ‚îÄ scripts/
    ‚îú‚îÄ‚îÄ deploy.sh
    ‚îú‚îÄ‚îÄ backup.sh
    ‚îî‚îÄ‚îÄ health-check.sh
```

## üîß Implementa√ß√£o Detalhada

1. **Backend API (Node.js + Express)**
   - Estrutura da API:
     ```typescript
     // api/src/app.ts
     import express from 'express';
     import cors from 'cors';
     import helmet from 'helmet';
     import rateLimit from 'express-rate-limit';
     import { createClient } from '@supabase/supabase-js';

     const app = express();

     // Middlewares de seguran√ßa
     app.use(helmet());
     app.use(cors({ origin: process.env.FRONTEND_URL }));
     app.use(express.json({ limit: '10mb' }));

     // Rate limiting
     const limiter = rateLimit({
       windowMs: 15 * 60 * 1000, // 15 minutos
       max: 100 // m√°ximo 100 requests por IP
     });
     app.use('/api/', limiter);

     // Routes
     app.use('/api/auth', authRoutes);
     app.use('/api/events', eventsRoutes);
     app.use('/api/donations', donationsRoutes);
     app.use('/api/members', membersRoutes);
     app.use('/api/reports', reportsRoutes);
     ```

   - Principais endpoints:
     - **Home (P√°gina P√∫blica):**
       - `GET /api/events?upcoming=true&limit=6`: Busca os pr√≥ximos 6 eventos.
       - `GET /api/streams/live`: Verifica se h√° transmiss√£o ao vivo.
       - `GET /api/streams?status=finalizado&limit=6`: Busca as √∫ltimas 6 grava√ß√µes.
       - `GET /api/donations/stats`: Busca estat√≠sticas de doa√ß√µes.
     - **Login:**
       - `POST /api/auth/login`: Autentica o usu√°rio.
     - **Painel (Dashboard e Se√ß√µes):**
       - **Dashboard:**
         - `GET /api/events/stats`: Estat√≠sticas de eventos (ex: total, por m√™s).
         - `GET /api/members/stats`: Estat√≠sticas de membros (ex: total, ativos).
         - `GET /api/visitors/stats`: Estat√≠sticas de visitantes.
         - `GET /api/members/birthdays`: Aniversariantes da semana.
       - **Eventos:**
         - `GET /api/events`: Lista todos os eventos.
         - `POST /api/events`: Cria um novo evento.
         - `PUT /api/events/:id`: Atualiza um evento.
         - `DELETE /api/events/:id`: Deleta um evento.
       - **Transmiss√µes:**
         - `GET /api/streams`: Lista todas as transmiss√µes.
         - `POST /api/streams`: Cria uma nova transmiss√£o.
         - `PUT /api/streams/:id`: Atualiza uma transmiss√£o.
         - `DELETE /api/streams/:id`: Deleta uma transmiss√£o.
       - **Doa√ß√µes:**
         - `GET /api/donations`: Lista todas as doa√ß√µes (com filtros).
         - `POST /api/donations`: Cria uma nova doa√ß√£o.
         - `PUT /api/donations/:id`: Atualiza uma doa√ß√£o.
         - `DELETE /api/donations/:id`: Deleta uma doa√ß√£o.
         - `POST /api/donations/receipt`: Upload de comprovante.
         - `GET /api/donations/export`: Exporta doa√ß√µes (CSV/PDF).
       - **Membros:**
         - `GET /api/members`: Lista todos os membros (com filtros).
         - `POST /api/members`: Cria um novo membro.
         - `PUT /api/members/:id`: Atualiza um membro.
         - `DELETE /api/members/:id`: Deleta um membro.
         - `POST /api/members/:id/deactivate`: Desativa um membro.
       - **Visitantes:**
         - `GET /api/visitors`: Lista todos os visitantes.
         - `POST /api/visitors`: Cria um novo visitante.
         - `PUT /api/visitors/:id`: Atualiza um visitante.
         - `DELETE /api/visitors/:id`: Deleta um visitante.
       - **Visitas Pastorais:**
         - `GET /api/pastoral-visits`: Lista todas as visitas.
         - `POST /api/pastoral-visits`: Cria um novo visita.
         - `PUT /api/pastoral-visits/:id`: Atualiza um visita.
         - `DELETE /api/pastoral-visits/:id`: Deleta um visita.
         - `GET /api/pastoral-visits/stats`: Estat√≠sticas de visitas.
       - **Minist√©rios:**
         - `GET /api/ministries`: Lista todos os minist√©rios.
         - `POST /api/ministries`: Cria um novo minist√©rio.
         - `PUT /api/ministries/:id`: Atualiza um minist√©rio.
         - `DELETE /api/ministries/:id`: Deleta um minist√©rio.
         - `GET /api/ministries/:id/members`: Lista membros de um minist√©rio.
         - `POST /api/ministries/members`: Adiciona membro a um minist√©rio.
         - `DELETE /api/ministries/members/:id`: Remove membro de um minist√©rio.
       - **Controle de Assist√™ncia:**
         - `GET /api/attendance`: Lista todas as presen√ßas com pagina√ß√£o.
         - `GET /api/attendance/event/:eventId`: Presen√ßas por evento espec√≠fico.
         - `GET /api/attendance/stats`: Estat√≠sticas de presen√ßa.
         - `POST /api/attendance`: Marcar presen√ßa em evento.
         - `PUT /api/attendance/:id`: Atualizar presen√ßa (requer permiss√µes).

2. **Frontend (React + Vite)**
   - **Configura√ß√£o de Ambiente:**
     - Criar um arquivo `.env` na raiz do frontend com a vari√°vel `VITE_API_URL=http://localhost:4000` (ou o endere√ßo da API).
   - **Autentica√ß√£o:**
     - Modificar `src/contexts/AuthContext.tsx` para usar a API em vez de `localStorage`.
     - A fun√ß√£o `login` deve fazer uma chamada `POST /api/auth/login`.
     - A fun√ß√£o `logout` deve chamar `POST /api/auth/logout`.
     - O estado de autentica√ß√£o deve ser gerenciado com base no token JWT recebido da API.
   - **Migra√ß√£o de Dados (localStorage para API):**
     - Substituir o uso de `localStorage` em todos os componentes de gerenciamento (`EventsManager`, `DonationsManager`, etc.) por chamadas √† API.
     - Utilizar `@tanstack/react-query` para gerenciar o estado do servidor (fetching, caching, updating).
     - Criar hooks customizados (ex: `useEvents`, `useMembers`) para encapsular a l√≥gica de acesso √† API com React Query.
   - **Componentes de UI:**
     - Adaptar os componentes para lidar com os estados de `isLoading`, `error` e `isSuccess` do React Query, mostrando indicadores de carregamento e mensagens de erro adequadas.

2. **Seguran√ßa & Autentica√ß√£o**
   - JWT Middleware:
     ```typescript
     // api/src/middleware/auth.ts
     import jwt from 'jsonwebtoken';
     import { createClient } from '@supabase/supabase-js';

     export const authenticateToken = async (req, res, next) => {
       const token = req.headers.authorization?.split(' ')[1];

       if (!token) {
         return res.status(401).json({ error: 'Token required' });
       }

       try {
         const supabase = createClient(
           process.env.SUPABASE_URL!,
           process.env.SUPABASE_SERVICE_KEY!
         );

         const { data: { user }, error } = await supabase.auth.getUser(token);

         if (error || !user) {
           return res.status(401).json({ error: 'Invalid token' });
         }

         req.user = user;
         next();
       } catch (error) {
         res.status(403).json({ error: 'Token validation failed' });
       }
     };
     ```
   - RBAC Middleware:
     ```typescript
     export const requireRole = (roles: string[]) => {
       return async (req, res, next) => {
         const userRole = req.user.user_metadata?.role || 'member';

         if (!roles.includes(userRole)) {
           return res.status(403).json({ error: 'Insufficient permissions' });
         }

         next();
       };
     };
     ```

3. **Background Jobs & Cron**
   - Worker Service:
     ```typescript
     // api/src/workers/cronJobs.ts
     import cron from 'node-cron';
     import { generateReports } from '../services/reportService';
     import { backupDatabase } from '../services/backupService';

     // Relat√≥rios di√°rios √†s 6h
     cron.schedule('0 6 * * *', async () => {
       console.log('Gerando relat√≥rios di√°rios...');
       await generateReports('daily');
     });

     // Backup semanal aos domingos √†s 2h
     cron.schedule('0 2 * * 0', async () => {
       console.log('Executando backup semanal...');
       await backupDatabase();
     });

     // Limpeza de logs mensalmente
     cron.schedule('0 0 1 * *', async () => {
       console.log('Limpando logs antigos...');
       await cleanOldLogs();
     });
     ```

4. **Cache Strategy (Redis Cloud)**
   - Servi√ßo de cache:
     ```typescript
     // api/src/services/cacheService.ts
     import Redis from 'ioredis';

     const redis = new Redis(process.env.REDIS_URL);

     export const cacheService = {
       async get(key: string) {
         const cached = await redis.get(key);
         return cached ? JSON.parse(cached) : null;
       },

       async set(key: string, data: any, ttl: number = 3600) {
         await redis.setex(key, ttl, JSON.stringify(data));
       },

       async invalidate(pattern: string) {
         const keys = await redis.keys(pattern);
         if (keys.length > 0) {
           await redis.del(...keys);
         }
       }
     };

     // Uso: cache de estat√≠sticas por 1h
     app.get('/api/stats', async (req, res) => {
       const cached = await cacheService.get('stats:dashboard');
       if (cached) return res.json(cached);

       const stats = await getDashboardStats();
       await cacheService.set('stats:dashboard', stats, 3600);
       res.json(stats);
     });
     ```

## üîí Estrat√©gias de Seguran√ßa

- Sanitiza√ß√£o & Valida√ß√£o
  ```typescript
  // api/src/middleware/validation.ts
  import { z } from 'zod';
  import DOMPurify from 'isomorphic-dompurify';

  const eventSchema = z.object({
    title: z.string().min(1).max(200),
    description: z.string().max(2000),
    date: z.string().datetime(),
    capacity: z.number().int().positive().max(1000)
  });

  export const validateAndSanitize = (schema: z.ZodSchema) => {
    return (req, res, next) => {
      try {
        // Sanitizar strings
        const sanitized = Object.keys(req.body).reduce((acc, key) => {
          const value = req.body[key];
          acc[key] = typeof value === 'string' ? DOMPurify.sanitize(value) : value;
          return acc;
        }, {});

        // Validar com Zod
        const validated = schema.parse(sanitized);
        req.body = validated;
        next();
      } catch (error) {
        res.status(400).json({ error: 'Validation failed', details: error.errors });
      }
    };
  };
  ```
- Rate Limiting Espec√≠fico
  ```typescript
  // Diferentes limites por endpoint
  const authLimiter = rateLimit({
    windowMs: 15 * 60 * 1000,
    max: 5, // Apenas 5 tentativas de login por 15min
    message: 'Muitas tentativas de login'
  });

  const uploadLimiter = rateLimit({
    windowMs: 60 * 1000,
    max: 10, // 10 uploads por minuto
    message: 'Limite de upload excedido'
  });

  app.use('/api/auth/login', authLimiter);
  app.use('/api/upload', uploadLimiter);
  ```
- File Upload Security
  ```typescript
  // api/src/services/uploadService.ts
  import multer from 'multer';
  import sharp from 'sharp';

  const ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/webp'];
  const MAX_SIZE = 5 * 1024 * 1024; // 5MB

  const upload = multer({
    storage: multer.memoryStorage(),
    limits: { fileSize: MAX_SIZE },
    fileFilter: (req, file, cb) => {
      if (ALLOWED_TYPES.includes(file.mimetype)) {
        cb(null, true);
      } else {
        cb(new Error('Tipo de arquivo n√£o permitido'));
      }
    }
  });

  export const uploadImage = async (file: Express.Multer.File) => {
    // Comprimir imagem
    const compressedBuffer = await sharp(file.buffer)
      .jpeg({ quality: 80 })
      .resize(1200, 1200, { fit: 'inside', withoutEnlargement: true })
      .toBuffer();

    // Upload para Supabase Storage
    const fileName = `${Date.now()}-${Math.random().toString(36).substr(2, 9)}.jpg`;
    const { data, error } = await supabase.storage
      .from('images')
      .upload(fileName, compressedBuffer, {
        contentType: 'image/jpeg'
      });

    if (error) throw error;
    return data.path;
  };
  ```

## üìä Dados de Produ√ß√£o & Configura√ß√µes

- Configura√ß√£o `.env.production`:
  ```env
  NODE_ENV=production
  PORT=4000

  # Supabase
  VITE_SUPABASE_URL=https://pzchczilvfhzudybmgms.supabase.co
  VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
  SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

  # Database
  DATABASE_URL=postgresql://postgres:2GZPkxTmfSiTY64E@db.pzchczilvfhzudybmgms.supabase.co:5432/postgres

  # Redis Cache (Upstash Free)
  REDIS_URL=redis://default:password@region.upstash.io:6379

  # Security
  JWT_SECRET=sua_chave_super_secreta_256_bits
  ENCRYPTION_KEY=sua_chave_de_criptografia_32_bytes

  # Cloudflare
  CLOUDFLARE_TUNNEL_TOKEN=eyJhIjoiYWQ4NjRiN2Q3ZjRjMDM3OThmYWQwM2VjMGQzY2RkYTgiLCJ0IjoiNDNkZWVkNjktYjNkYS00NmNhLTlkYzItNDIyMmJkYWNkODRkIiw
  icyI6Ik1qYzVNalUwWlRrdFpXWm1aQzAwWWpSa0xUa3pOemd0T1dKaE5Ea3pZVE0zTjJWaCJ9

  # Monitoring
  LOG_LEVEL=info
  ENABLE_METRICS=true
  ```

- Volume de Dados Esperado:
  - Usu√°rios: 100-200 membros ativos
  - Eventos: 4-8 por m√™s (48-96/ano)
  - Doa√ß√µes: 50-100 por m√™s (600-1200/ano)
  - Storage: 2-5GB (fotos, recibos, documentos)
  - DB Size: ~500MB
  - Traffic: ~1000 requests/dia

## üöÄ Deployment & Scripts

- Script de Deploy:
  ```bash
  #!/bin/bash
  # scripts/deploy.sh

  echo "üöÄ Iniciando deploy da CCCP..."

  # Build das imagens
  docker-compose -f docker-compose.yml build --no-cache

  # Parar servi√ßos antigos
  docker-compose down

  # Iniciar novos servi√ßos
  docker-compose up -d

  # Verificar sa√∫de dos servi√ßos
  sleep 30
  bash scripts/health-check.sh

  echo "‚úÖ Deploy conclu√≠do!"
  ```
- Health Check:
  ```bash
  #!/bin/bash
  # scripts/health-check.sh

  API_URL="http://localhost:4000"
  FRONTEND_URL="http://localhost:3000"

  # Verificar API
  if curl -f -s "$API_URL/health" > /dev/null; then
      echo "‚úÖ API is healthy"
  else
      echo "‚ùå API is down"
      exit 1
  fi

  # Verificar Frontend
  if curl -f -s "$FRONTEND_URL" > /dev/null; then
      echo "‚úÖ Frontend is healthy"
  else
      echo "‚ùå Frontend is down"
      exit 1
  fi

  echo "üéâ All services are running!"
  ```
- Backup Automatizado:
  ```bash
  #!/bin/bash
  # scripts/backup.sh

  BACKUP_DIR="/backups"
  DATE=$(date +"%Y%m%d_%H%M%S")

  # Backup do banco via Supabase
  curl -X POST "https://api.supabase.com/v1/projects/${SUPABASE_PROJECT_ID}/database/backups" \
    -H "Authorization: Bearer ${SUPABASE_SERVICE_KEY}" \
    -H "Content-Type: application/json"

  # Backup de arquivos do storage
  mkdir -p "$BACKUP_DIR/$DATE"
  # Script customizado para download dos arquivos do Supabase Storage

  echo "üì¶ Backup realizado: $BACKUP_DIR/$DATE"
  ```

## üìà Monitoramento Simples

- Logging Strategy:
  ```typescript
  // api/src/utils/logger.ts
  import winston from 'winston';

  export const logger = winston.createLogger({
    level: process.env.LOG_LEVEL || 'info',
    format: winston.format.combine(
      winston.format.timestamp(),
      winston.format.errors({ stack: true }),
      winston.format.json()
    ),
    transports: [
      new winston.transports.File({ filename: 'logs/error.log', level: 'error' }),
      new winston.transports.File({ filename: 'logs/combined.log' }),
      new winston.transports.Console({
        format: winston.format.simple()
      })
    ]
  });

  // Middleware de log de requests
  export const requestLogger = (req, res, next) => {
    const start = Date.now();

    res.on('finish', () => {
      const duration = Date.now() - start;
      logger.info({
        method: req.method,
        url: req.url,
        status: res.statusCode,
        duration: `${duration}ms`,
        ip: req.ip,
        userAgent: req.get('User-Agent')
      });
    });

    next();
  };
  ```

## ‚ö° Otimiza√ß√µes & Performance

- Dockerfiles Otimizados:
  - Frontend Dockerfile:
    ```dockerfile
    # frontend/Dockerfile
    FROM node:18-alpine AS builder

    WORKDIR /app
    COPY package*.json ./
    RUN npm ci --only=production

    COPY . .
    RUN npm run build

    FROM nginx:alpine
    COPY --from=builder /app/dist /usr/share/nginx/html
    COPY nginx.conf /etc/nginx/nginx.conf

    EXPOSE 3000
    CMD ["nginx", "-g", "daemon off;"]
    ```
  - API Dockerfile:
    ```dockerfile
    # api/Dockerfile
    FROM node:18-alpine AS builder

    WORKDIR /app
    COPY package*.json ./
    RUN npm ci --only=production

    COPY . .
    RUN npm run build

    FROM node:18-alpine
    WORKDIR /app

    RUN addgroup -g 1001 -S nodejs
    RUN adduser -S nextjs -u 1001

    COPY --from=builder /app/dist ./dist
    COPY --from=builder /app/node_modules ./node_modules
    COPY package*.json ./

    USER nextjs
    EXPOSE 4000

    CMD ["node", "dist/app.js"]
    ```

## üéØ Roadmap de Implementa√ß√£o

**Fase 1 - Setup Inicial (Semana 1-2)**
1. Reestrutura√ß√£o do projeto para arquitetura monorepo.
2. Cria√ß√£o da API Node.js com estrutura base.
3. Dockeriza√ß√£o dos servi√ßos frontend e backend.
4. Configura√ß√£o do Cloudflare Tunnel para acesso externo.

**Fase 2 - Migra√ß√£o de Funcionalidades (Semana 3-4)**
1. Migra√ß√£o gradual das chamadas diretas do Supabase para API.
2. Implementa√ß√£o de middleware de autentica√ß√£o e autoriza√ß√£o.
3. Adi√ß√£o de valida√ß√£o e sanitiza√ß√£o de dados.
4. Sistema de cache com Redis para queries frequentes.

**Fase 3 - Seguran√ßa & Estabilidade (Semana 5-6)**
1. Rate limiting e prote√ß√£o contra ataques.
2. Sistema de logs estruturados.
3. Backup automatizado e recovery procedures.
4. Health checks e monitoring b√°sico.

**Fase 4 - Otimiza√ß√µes & Features (Semana 7-8)**
1. Background jobs para relat√≥rios e manuten√ß√£o.
2. Compress√£o de imagens autom√°tica.
3. Export de dados em m√∫ltiplos formatos.
4. Push notifications via OneSignal.

## üí∞ Custos Operacionais

- Supabase: R$ 0 (Free Tier - 500MB DB, 1GB Storage, 2GB Bandwidth)
- Cloudflare Tunnel: R$ 0 (Gratuito)
- Upstash Redis: R$ 0 (Free Tier - 10k commands/day)
- OneSignal: R$ 0 (Free Tier - 10k notifications/month)
- Hospedagem: R$ 0 (assumindo VPS pr√≥pria ou servidor local)

**TOTAL:** R$ 0/m√™s üéâ

**Upgrade Path (se necess√°rio):**
- Supabase Pro: $25/m√™s (~R$ 125) - 8GB DB, 100GB Storage
- Upstash Pro: $10/m√™s (~R$ 50) - 100k commands/day
- VPS Dedicada: R$ 50-100/m√™s - Para controle total

**TOTAL Upgrade:** ~R$ 225/m√™s

## üîê Checklist de Seguran√ßa Final

**‚úÖ Implementado**
- JWT Authentication via Supabase
- RBAC com roles (admin, leader, member)
- HTTPS obrigat√≥rio via Cloudflare
- Vari√°veis de ambiente protegidas
- Row Level Security no Supabase

**üöÄ A Implementar**
- Rate limiting por endpoint
- Sanitiza√ß√£o de inputs (DOMPurify)
- Valida√ß√£o com Zod schemas
- File upload security (type validation + compression)
- Request/Response logging
- CORS restritivo para dom√≠nios espec√≠ficos
- Content Security Policy headers
- Backup automatizado semanal

---

**Este plano garante:**
- ‚úÖ Custo Zero mantendo Free Tiers
- ‚úÖ M√°xima Seguran√ßa com m√∫ltiplas camadas
- ‚úÖ Alta Disponibilidade via Docker + Health Checks
- ‚úÖ Escalabilidade f√°cil quando necess√°rio
- ‚úÖ Manutenibilidade com c√≥digo organizado e documentado