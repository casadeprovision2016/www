# üèõÔ∏è Database Schema - CCCP Casa de Provisi√≥n

## üìã Vis√£o Geral

Este diret√≥rio cont√©m a estrutura completa do banco de dados do sistema CCCP (Centro Cristiano Casa de Provisi√≥n). O banco √© constru√≠do em PostgreSQL via Supabase e inclui todas as tabelas, √≠ndices, fun√ß√µes, gatilhos e pol√≠ticas de seguran√ßa necess√°rias.

## üóÉÔ∏è Estrutura dos Arquivos

### Ordem de Execu√ß√£o (IMPORTANTE!)

Execute os arquivos SQL na seguinte ordem no SQL Editor do Supabase:

1. **`01_schema_tabelas.sql`** - Tabelas principais
2. **`02_indices_performance.sql`** - √çndices de performance  
3. **`03_funcoes_gatilhos.sql`** - Fun√ß√µes e gatilhos
4. **`04_row_level_security.sql`** - Pol√≠ticas de seguran√ßa
5. **`05_dados_exemplo.sql`** - Dados de exemplo

## üìä Estrutura das Tabelas

### Tabelas Principais

| Tabela | Descri√ß√£o | Rela√ß√µes |
|--------|-----------|----------|
| **`organization`** | Configura√ß√µes da igreja | - |
| **`users`** | Dados estendidos dos usu√°rios | `auth.users` |
| **`events`** | Eventos da igreja | `users` (created_by) |
| **`members`** | Status de membership | `users` |
| **`ministries`** | Minist√©rios da igreja | `users` (lider_id) |
| **`ministry_members`** | Membros dos minist√©rios | `ministries`, `users` |
| **`donations`** | Doa√ß√µes e ofertas | `users` |
| **`contributions`** | Contribui√ß√µes para projetos | `users` |
| **`live_streams`** | Transmiss√µes ao vivo | `events`, `users` |
| **`event_registrations`** | Inscri√ß√µes em eventos | `events`, `users` |
| **`pastoral_visits`** | Visitas pastorais | `users` (visitado, pastor) |
| **`notifications`** | Sistema de notifica√ß√µes | `users` |

## üîê Sistema de Roles

### Hierarquia de Permiss√µes

1. **`admin`** - Acesso total ao sistema
2. **`pastor`** - Acesso a todas as funcionalidades ministeriais
3. **`leader`** - Lideran√ßa de minist√©rios espec√≠ficos
4. **`member`** - Membro da igreja com acesso b√°sico

### Row Level Security (RLS)

Todas as tabelas possuem RLS habilitado com pol√≠ticas espec√≠ficas:

- **Usu√°rios**: Podem ver/editar seus pr√≥prios dados
- **Eventos**: P√∫blicos vis√≠veis para todos, privados para membros
- **Doa√ß√µes**: Usu√°rios veem apenas suas doa√ß√µes
- **Minist√©rios**: L√≠deres gerenciam seus minist√©rios
- **Notifica√ß√µes**: Cada usu√°rio v√™ apenas suas notifica√ß√µes

## üöÄ Funcionalidades Implementadas

### Fun√ß√µes Automatizadas

- **`update_updated_at_column()`** - Atualiza timestamp automaticamente
- **`handle_new_user()`** - Cria registro em `users` ap√≥s auth signup
- **`validate_event_schedule()`** - Previne conflitos de hor√°rio
- **`validate_event_capacity()`** - Controla lota√ß√£o de eventos
- **`get_donation_stats()`** - Estat√≠sticas de doa√ß√µes
- **`get_upcoming_events()`** - Eventos pr√≥ximos
- **`create_notification()`** - Criar notifica√ß√µes
- **`cleanup_expired_notifications()`** - Limpeza autom√°tica

### Gatilhos Ativos

- **Updated At**: Todas as tabelas atualizam `updated_at` automaticamente
- **Novo Usu√°rio**: Cria registro em `users` ap√≥s signup
- **Valida√ß√£o de Eventos**: Previne conflitos de hor√°rio e lota√ß√£o
- **Auditoria**: Logs autom√°ticos de mudan√ßas importantes

### √çndices de Performance

- **Busca por Texto**: √çndices GIN para busca full-text
- **Datas**: √çndices em campos de data para relat√≥rios
- **Relacionamentos**: Foreign keys indexadas
- **Consultas Frequentes**: √çndices compostos otimizados

## üìà Dados de Exemplo

O arquivo `05_dados_exemplo.sql` inclui:

- ‚úÖ 1 organiza√ß√£o configurada
- ‚úÖ 6 usu√°rios com diferentes roles
- ‚úÖ 10 minist√©rios ativos
- ‚úÖ 7 eventos variados
- ‚úÖ Doa√ß√µes de exemplo
- ‚úÖ Relacionamentos entre membros e minist√©rios
- ‚úÖ Transmiss√µes ao vivo
- ‚úÖ Notifica√ß√µes de boas-vindas

## üõ†Ô∏è Como Usar

### 1. Prepara√ß√£o no Supabase

```sql
-- 1. Certifique-se de que a extens√£o pg_trgm est√° habilitada
CREATE EXTENSION IF NOT EXISTS pg_trgm;

-- 2. Execute os arquivos na ordem correta
-- (cole cada arquivo no SQL Editor)
```

### 2. Verifica√ß√£o da Instala√ß√£o

```sql
-- Verificar se todas as tabelas foram criadas
SELECT schemaname, tablename 
FROM pg_tables 
WHERE schemaname = 'public' 
ORDER BY tablename;

-- Verificar dados de exemplo
SELECT 
    (SELECT COUNT(*) FROM public.users) as usuarios,
    (SELECT COUNT(*) FROM public.events) as eventos,
    (SELECT COUNT(*) FROM public.ministries) as ministerios;
```

### 3. Teste de Autentica√ß√£o

```sql
-- Testar se o usu√°rio pastor existe
SELECT id, email, nome, role 
FROM public.users 
WHERE email = 'pastor@casadeprovision.es';
```

## üîß Configura√ß√µes Necess√°rias

### Vari√°veis de Ambiente

Certifique-se de que estas vari√°veis est√£o configuradas:

```env
SUPABASE_URL=your_supabase_url
SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
```

### Autentica√ß√£o

O usu√°rio administrador deve ser criado via Supabase Auth:

```javascript
// No Supabase Auth
await supabase.auth.signUp({
  email: 'pastor@casadeprovision.es',
  password: 'sua_senha_segura'
})
```

## üìã Checklist de Instala√ß√£o

- [ ] Executar `01_schema_tabelas.sql`
- [ ] Executar `02_indices_performance.sql`
- [ ] Executar `03_funcoes_gatilhos.sql`
- [ ] Executar `04_row_level_security.sql`
- [ ] Executar `05_dados_exemplo.sql`
- [ ] Verificar se todas as tabelas existem
- [ ] Testar login com usu√°rio pastor
- [ ] Verificar se RLS est√° funcionando
- [ ] Testar API endpoints

## üö® Troubleshooting

### Problema: RLS bloqueando consultas

```sql
-- Temporariamente desabilitar RLS para debug
ALTER TABLE public.ministries DISABLE ROW LEVEL SECURITY;

-- Reabilitar ap√≥s testes
ALTER TABLE public.ministries ENABLE ROW LEVEL SECURITY;
```

### Problema: Gatilhos n√£o funcionando

```sql
-- Verificar se gatilhos existem
SELECT schemaname, tablename, triggername 
FROM pg_trigger t 
JOIN pg_class c ON t.tgrelid = c.oid 
JOIN pg_namespace n ON c.relnamespace = n.oid;
```

### Problema: √çndices faltando

```sql
-- Listar √≠ndices
SELECT schemaname, tablename, indexname 
FROM pg_indexes 
WHERE schemaname = 'public'
ORDER BY tablename, indexname;
```

## üìû Suporte

Para problemas com o banco de dados:

1. Verifique os logs do Supabase
2. Confirme que todos os arquivos foram executados na ordem
3. Teste as queries diretamente no SQL Editor
4. Verifique as pol√≠ticas RLS se houver problemas de permiss√£o

---

**Criado para CCCP - Casa de Provisi√≥n** üèõÔ∏è  
*Sistema de Gerenciamento Eclesi√°stico Completo*