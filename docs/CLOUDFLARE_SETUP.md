# üå©Ô∏è Configuraci√≥n del Cloudflare Tunnel - CCCP

## üìã Pr√©-requisitos

1. **Conta Cloudflare**: Tenha uma conta ativa no [Cloudflare](https://cloudflare.com)
2. **Dom√≠nio**: Dom√≠nio gerenciado pelo Cloudflare (pode ser gratuito)
3. **Zero Trust**: Acesso ao painel Zero Trust do Cloudflare

## üöÄ Configuraci√≥n Paso a Paso

### 1. Criar o Tunnel no Cloudflare

1. Acesse o [painel Cloudflare](https://dash.cloudflare.com)
2. V√° para **Zero Trust** > **Access** > **Tunnels**
3. Clique em **"Create a tunnel"**
4. Selecione **"Cloudflared"** como conector
5. D√™ um nome ao t√∫nel: `cccp-tunnel`
6. **Copie o token gerado** (ser√° usado no pr√≥ximo passo)

### 2. Configurar Vari√°veis de Ambiente

Crie um arquivo `.env.production` baseado no `.env.cloudflare`:

```bash
# Copiar template
cp .env.cloudflare .env.production

# Editar com suas configura√ß√µes
nano .env.production
```

Configure as seguintes vari√°veis:

```env
# Token obtido no passo anterior
CLOUDFLARE_TUNNEL_TOKEN=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# Seu dom√≠nio (substitua example.com)
CLOUDFLARE_DOMAIN=cccp.suaempresa.com
CLOUDFLARE_API_DOMAIN=api.cccp.suaempresa.com
```

### 3. Configurar DNS no Cloudflare

No painel do Cloudflare, v√° para **DNS** > **Records** e adicione:

| Tipo  | Nome | Destino | Status |
|-------|------|---------|--------|
| CNAME | cccp | [tunnel-id].cfargotunnel.com | Proxy ‚úÖ |
| CNAME | api.cccp | [tunnel-id].cfargotunnel.com | Proxy ‚úÖ |

> **Nota**: O `[tunnel-id]` ser√° fornecido pelo Cloudflare ao criar o t√∫nel

### 4. Configurar Rotas no Tunnel

No painel do t√∫nel criado, configure as rotas:

#### Rota Principal (Frontend)
- **Hostname**: `cccp.suaempresa.com`
- **Service**: `http://frontend:80`
- **Path**: `/`

#### Rota API (Opcional)
- **Hostname**: `api.cccp.suaempresa.com`  
- **Service**: `http://api:4000`
- **Path**: `/`

### 5. Iniciar o Sistema com Cloudflare

```bash
# Cargar variables de producci√≥n
export $(cat .env.production | xargs)

# Iniciar todos os servi√ßos incluindo Cloudflare
docker compose --profile production up -d

# Verificar status
docker compose ps
```

## üîç Verificaci√≥n y Pruebas

### Verificar Status do Tunnel

```bash
# Ver logs do t√∫nel
docker compose logs cloudflare-tunnel -f

# Verificar m√©tricas
curl http://localhost:8080/metrics
```

### Testar Conectividade Externa

```bash
# Testar frontend p√∫blico
curl -I https://cccp.suaempresa.com

# Testar API p√∫blica (se configurada)
curl https://api.cccp.suaempresa.com/health
```

## üìä Monitoramento

O t√∫nel Cloudflare exp√µe m√©tricas na porta `8080`:

- **M√©tricas**: `http://localhost:8080/metrics`
- **Health Check**: Autom√°tico via Docker
- **Logs**: Estructurados con rotaci√≥n autom√°tica

## üîß Configura√ß√µes Avan√ßadas

### Personalizar Configuraci√≥n del Tunnel

Edite o arquivo `cloudflare/config.yml` para:

- Adicionar mais rotas
- Configurar autenticaci√≥n
- Ajustar timeouts
- Personalizar headers

### Ejemplo de Configuraci√≥n Personalizada

```yaml
ingress:
  # Ruta con autenticaci√≥n
  - hostname: admin.cccp.suaempresa.com
    service: http://frontend:80
    originRequest:
      httpHostHeader: admin.cccp.suaempresa.com
      access:
        required: true
        teamName: sua-equipe

  # Rota com headers customizados
  - hostname: cccp.suaempresa.com
    service: http://frontend:80
    originRequest:
      httpHostHeader: cccp.suaempresa.com
      originServerName: cccp.suaempresa.com
      caPool: /etc/ssl/certs/ca-certificates.crt
```

## üõ°Ô∏è Seguran√ßa

### Headers de Seguran√ßa Autom√°ticos

O Cloudflare adiciona automaticamente:

- **DDoS Protection**: Protecci√≥n contra ataques
- **WAF**: Web Application Firewall
- **SSL/TLS**: Certificados autom√°ticos
- **Rate Limiting**: Limitaci√≥n de tasa

### Configura√ß√µes Recomendadas

No painel Cloudflare, configure:

1. **SSL/TLS**: Full (strict)
2. **Security Level**: Medium
3. **DDoS Protection**: Enabled
4. **WAF**: Enabled com regras customizadas

## üö® Troubleshooting

### Problemas Comuns

1. **Tunnel n√£o conecta**:
   ```bash
   # Verificar token
   echo $CLOUDFLARE_TUNNEL_TOKEN
   
   # Verificar logs
   docker compose logs cloudflare-tunnel
   ```

2. **DNS n√£o resolve**:
   - Verificar configuraci√≥n CNAME
   - Esperar propagaci√≥n DNS (hasta 48h)

3. **Servi√ßos internos n√£o respondem**:
   ```bash
   # Verificar sa√∫de dos servi√ßos
   docker compose ps
   
   # Testar conectividade interna
   docker exec cccp-cloudflare-tunnel wget -qO- http://frontend:80/health
   ```

### Logs √öteis

```bash
# Logs completos do t√∫nel
docker compose logs cloudflare-tunnel --tail=100 -f

# Logs de todos os servi√ßos
docker compose logs -f

# Status detalhado
docker compose ps -a
```

## üìû Suporte

Para problemas espec√≠ficos:

1. **Documentaci√≥n Cloudflare**: [developers.cloudflare.com](https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/)
2. **Logs do Sistema**: `docker compose logs`
3. **Issues do GitHub**: Abra uma issue no reposit√≥rio

---

**‚úÖ Sistema CCCP agora acess√≠vel globalmente via Cloudflare Tunnel!** üåç