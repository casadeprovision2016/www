# üê≥ Setup Docker para Microblog - Ense√±anzas de los Martes

Esta gu√≠a explica c√≥mo configurar y ejecutar la funcionalidad de microblog integrada con Blogger API en el ambiente Docker del sistema CCCP.

## üìã Requisitos Previos

- Docker y Docker Compose instalados
- API Key de Google Blogger configurada
- ID del blog de Blogger
- Acceso a la configuraci√≥n del proyecto CCCP

## üîß Configuraci√≥n del Ambiente

### 1. Variables de Entorno

**Archivo: `/api/.env`**
```env
# Configuraci√≥n existente...
NODE_ENV=production
PORT=4444
DATABASE_URL=postgresql://postgres:password@db.supabase.co:5432/postgres
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
REDIS_URL=redis://default:password@redis:6379
JWT_SECRET=your-jwt-secret

# Nueva configuraci√≥n para Blogger API
BLOGGER_API_KEY=AIzaSyAGzTT-4vd5AwSm_T34rWF_Q1vqiAiaOHY
```

**Archivo: `/frontend/.env`**
```env
# Configuraci√≥n existente...
VITE_API_URL=http://api:4444
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key

# Nueva configuraci√≥n para Blogger
VITE_BLOGGER_ID=YOUR_BLOG_ID_HERE
```

### 2. Actualizaci√≥n del Docker Compose

El `docker-compose.yml` ya est√° configurado para soportar las nuevas funcionalidades. Aseg√∫rate de que las variables de entorno est√©n disponibles:

```yaml
version: '3.8'
services:
  # Frontend React + Vite
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - VITE_API_URL=http://api:4444
      - VITE_SUPABASE_URL=${VITE_SUPABASE_URL}
      - VITE_SUPABASE_ANON_KEY=${VITE_SUPABASE_ANON_KEY}
      - VITE_BLOGGER_ID=${VITE_BLOGGER_ID}  # Nueva variable
    depends_on:
      - api
    networks:
      - cccp-network

  # Backend API Node.js
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    ports:
      - "4444:4444"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=${DATABASE_URL}
      - SUPABASE_URL=${VITE_SUPABASE_URL}
      - SUPABASE_ANON_KEY=${VITE_SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - REDIS_URL=${REDIS_URL}
      - JWT_SECRET=${JWT_SECRET}
      - BLOGGER_API_KEY=${BLOGGER_API_KEY}  # Nueva variable
    depends_on:
      - cron-jobs
    networks:
      - cccp-network

  # Resto de la configuraci√≥n...
```

## üöÄ Instalaci√≥n y Ejecuci√≥n

### 1. Preparar el Ambiente

```bash
# Clonar o actualizar el repositorio
cd /path/to/cccp

# Verificar que todas las dependencias est√©n actualizadas
cd api
npm install axios  # Asegurar que axios est√© instalado
cd ../frontend
npm install  # Verificar dependencias del frontend
cd ..
```

### 2. Configurar Variables de Entorno

```bash
# Copiar archivos de ejemplo (si existen)
cp api/.env.example api/.env
cp frontend/.env.example frontend/.env

# Editar los archivos .env con los valores correctos
nano api/.env
nano frontend/.env
```

### 3. Construir y Ejecutar

```bash
# Construir las im√°genes
docker-compose build --no-cache

# Ejecutar todos los servicios
docker-compose up -d

# Verificar que los servicios est√©n ejecut√°ndose
docker-compose ps
```

### 4. Verificar la Instalaci√≥n

```bash
# Verificar logs del API
docker-compose logs api

# Verificar logs del frontend
docker-compose logs frontend

# Probar endpoints del microblog
curl "http://localhost:4444/api/microblog/stats"
```

## üß™ Pruebas de Funcionalidad

### 1. Verificar API del Microblog

```bash
# Obtener estad√≠sticas (endpoint p√∫blico)
curl -X GET "http://localhost:4444/api/microblog/stats" \
     -H "Content-Type: application/json"

# Respuesta esperada:
{
  "success": true,
  "data": {
    "categories": [
      {
        "name": "Ense√±anzas de Martes",
        "slug": "ense√±anzas-martes",
        "description": "Ense√±anzas semanales de los martes"
      }
      // ... m√°s categor√≠as
    ],
    "totalCategories": 6,
    "status": "active"
  }
}
```

### 2. Verificar Autenticaci√≥n (con token)

```bash
# Obtener token de login primero
LOGIN_RESPONSE=$(curl -X POST "http://localhost:4444/api/auth/login" \
     -H "Content-Type: application/json" \
     -d '{"email":"admin@example.com","password":"password"}')

TOKEN=$(echo $LOGIN_RESPONSE | jq -r '.data.token')

# Obtener ense√±anzas de martes
curl -X GET "http://localhost:4444/api/microblog/ense√±anzas-martes?blogId=YOUR_BLOG_ID&maxResults=5" \
     -H "Authorization: Bearer $TOKEN" \
     -H "Content-Type: application/json"
```

### 3. Verificar Frontend

1. **Abrir el navegador**: `http://localhost:3000`
2. **Verificar secci√≥n**: Buscar "Ense√±anzas de los Martes" en la p√°gina principal
3. **Acceder al panel**: Login y verificar secci√≥n "Ense√±anzas" en el panel administrativo

## üîç Troubleshooting

### 1. Problemas Comunes

**Error: "API Key inv√°lida"**
```bash
# Verificar variable de entorno en el contenedor
docker-compose exec api printenv | grep BLOGGER

# Verificar logs para errores espec√≠ficos
docker-compose logs api | grep -i blogger
```

**Error: "Blog no encontrado"**
```bash
# Verificar variable de entorno del frontend
docker-compose exec frontend printenv | grep VITE_BLOGGER

# Verificar que el blog ID sea correcto
curl "https://www.googleapis.com/blogger/v3/blogs/YOUR_BLOG_ID?key=YOUR_API_KEY"
```

**Error: "Cache no funciona"**
```bash
# Verificar conexi√≥n Redis
docker-compose exec api node -e "
const Redis = require('ioredis');
const redis = new Redis(process.env.REDIS_URL);
redis.ping().then(console.log).catch(console.error);
"
```

### 2. Comandos de Diagn√≥stico

```bash
# Estado de todos los contenedores
docker-compose ps

# Logs en tiempo real
docker-compose logs -f api
docker-compose logs -f frontend

# Acceder al contenedor del API
docker-compose exec api bash

# Verificar conexiones de red
docker-compose exec api curl http://frontend:3000
docker-compose exec frontend curl http://api:4444/health
```

### 3. Reiniciar Servicios

```bash
# Reiniciar solo el API
docker-compose restart api

# Reiniciar solo el frontend
docker-compose restart frontend

# Reiniciar todo
docker-compose restart

# Reconstruir y reiniciar
docker-compose down
docker-compose build --no-cache
docker-compose up -d
```

## üìä Monitoreo

### 1. Health Checks

```bash
# Verificar salud general del sistema
curl "http://localhost:4444/health"

# Verificar estad√≠sticas del microblog
curl "http://localhost:4444/api/microblog/stats"

# Verificar frontend
curl "http://localhost:3000"
```

### 2. Logs Importantes

```bash
# Errores de la API de Blogger
docker-compose logs api | grep -i "blogger\|error"

# Errores de autenticaci√≥n
docker-compose logs api | grep -i "auth\|401\|403"

# Problemas de cache
docker-compose logs api | grep -i "redis\|cache"
```

### 3. Performance

```bash
# Uso de memoria
docker stats

# Espacio en disco
docker system df

# Limpiar recursos no utilizados
docker system prune -f
```

## üîÑ Mantenimiento

### 1. Actualizaciones

```bash
# Actualizar c√≥digo
git pull origin main

# Reconstruir contenedores
docker-compose build --no-cache

# Aplicar cambios
docker-compose up -d
```

### 2. Backup y Restore

```bash
# Backup de configuraci√≥n
cp -r api/.env frontend/.env /backup/location/

# Backup de logs importantes
docker-compose logs api > /backup/api-logs-$(date +%Y%m%d).log
docker-compose logs frontend > /backup/frontend-logs-$(date +%Y%m%d).log
```

### 3. Limpieza

```bash
# Limpiar cache de Redis
docker-compose exec api node -e "
const Redis = require('ioredis');
const redis = new Redis(process.env.REDIS_URL);
redis.flushall().then(() => console.log('Cache cleared'));
"

# Limpiar im√°genes Docker no utilizadas
docker image prune -f

# Limpiar todo el sistema Docker
docker system prune -af
```

## üõ°Ô∏è Seguridad en Producci√≥n

### 1. Variables de Entorno Seguras

```bash
# Usar Docker secrets en lugar de variables de entorno simples
echo "your-api-key" | docker secret create blogger_api_key -
echo "your-blog-id" | docker secret create blogger_blog_id -
```

### 2. Configuraci√≥n de Red

```bash
# Limitar acceso a puertos espec√≠ficos
# En docker-compose.yml, cambiar:
# ports: ["3000:3000"]  # ‚ùå Expone a todo
# a:
# ports: ["127.0.0.1:3000:3000"]  # ‚úÖ Solo localhost
```

### 3. Logs de Auditor√≠a

```bash
# Configurar rotaci√≥n de logs
# En docker-compose.yml:
logging:
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"
```

---

## üìû Soporte y Documentaci√≥n

**Documentaci√≥n adicional**:
- `/docs/BLOGGER_SETUP.md` - Configuraci√≥n detallada de Blogger API
- `/docs/README_BACKEND.md` - Documentaci√≥n del backend
- `/README.md` - Documentaci√≥n general del proyecto

**Para problemas espec√≠ficos**:
1. Revisar logs con los comandos de diagn√≥stico
2. Verificar variables de entorno
3. Consultar documentaci√≥n de Blogger API v3
4. Contactar al administrador del sistema

---

**Implementado por**: Claude Code Assistant  
**Fecha**: Enero 2025  
**Versi√≥n**: CCCP v1.0 con Microblog Integration