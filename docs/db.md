# üèõÔ∏è Documenta√ß√£o do Banco de Dados - CCCP Casa de Provisi√≥n

## üìã Vis√£o Geral

Este documento detalha a estrutura completa do banco de dados para o sistema de gerenciamento da igreja CCCP (Centro Cristiano Casa de Provisi√≥n). Ele √© projetado para ser executado em um ambiente PostgreSQL, como o Supabase.

A documenta√ß√£o abrange:
- **Schema das Tabelas**: Estrutura de todas as tabelas, colunas e seus relacionamentos.
- **√çndices**: Otimiza√ß√µes para performance de consultas.
- **Fun√ß√µes e Gatilhos**: L√≥gica de banco de dados automatizada.
- **Seguran√ßa**: Pol√≠ticas de Row Level Security (RLS) para controle de acesso.
- **Dados de Exemplo**: Informa√ß√µes sobre os dados iniciais para teste e desenvolvimento.

---

## üóÉÔ∏è Arquivos SQL e Ordem de Execu√ß√£o

Para configurar o banco de dados do zero, os seguintes arquivos devem ser executados na ordem especificada:

1.  **`database/01_schema_tabelas.sql`**: Cria a estrutura de todas as tabelas principais.
2.  **`database/02_indices_performance.sql`**: Adiciona √≠ndices para otimizar as consultas.
3.  **`database/03_funcoes_gatilhos.sql`**: Implementa fun√ß√µes e gatilhos para automa√ß√µes.
4.  **`database/04_row_level_security_PRODU√áAO.sql`**: Ativa e configura as pol√≠ticas de seguran√ßa a n√≠vel de linha (RLS).
5.  **`database/05_dados_exemplo.sql`**: Popula o banco de dados com dados de exemplo para facilitar o desenvolvimento e testes.

---

## üìä Estrutura das Tabelas

A seguir, a descri√ß√£o detalhada de cada tabela no schema `public`.

### 1. `organization`
Armazena as configura√ß√µes e informa√ß√µes gerais da igreja.

| Coluna | Tipo | Descri√ß√£o |
| :--- | :--- | :--- |
| `id` | `UUID` | Chave prim√°ria, identificador √∫nico da organiza√ß√£o. |
| `nome` | `VARCHAR(200)` | Nome oficial da organiza√ß√£o. |
| `descricao` | `TEXT` | Descri√ß√£o sobre a igreja. |
| `endereco` | `TEXT` | Endere√ßo f√≠sico da igreja. |
| `telefone` | `VARCHAR(20)` | Telefone de contato. |
| `email` | `VARCHAR(100)` | E-mail de contato. |
| `website` | `VARCHAR(200)` | Site oficial. |
| `logo_url` | `TEXT` | URL para a imagem do logo. |
| `configuracoes`| `JSONB` | Configura√ß√µes diversas em formato JSON (hor√°rios, etc.). |
| `created_at` | `TIMESTAMPTZ` | Data de cria√ß√£o do registro. |
| `updated_at` | `TIMESTAMPTZ` | Data da √∫ltima atualiza√ß√£o do registro. |

### 2. `users`
Extens√£o da tabela `auth.users` do Supabase, contendo dados de perfil detalhados.

| Coluna | Tipo | Descri√ß√£o |
| :--- | :--- | :--- |
| `id` | `UUID` | Chave prim√°ria, referenciando `auth.users(id)`. |
| `email` | `VARCHAR(255)` | E-mail do usu√°rio (√∫nico). |
| `nome` | `VARCHAR(200)` | Nome completo do usu√°rio. |
| `telefone` | `VARCHAR(20)` | Telefone de contato. |
| `endereco` | `TEXT` | Endere√ßo do usu√°rio. |
| `data_nascimento`| `DATE` | Data de nascimento. |
| `profissao` | `VARCHAR(100)` | Profiss√£o do usu√°rio. |
| `estado_civil` | `VARCHAR(20)` | Estado civil (`solteiro`, `casado`, etc.). |
| `role` | `VARCHAR(20)` | Papel do usu√°rio no sistema (`admin`, `pastor`, `leader`, `member`). |
| `ativo` | `BOOLEAN` | Indica se o usu√°rio est√° ativo. |
| `foto_url` | `TEXT` | URL para a foto de perfil. |
| `observacoes` | `TEXT` | Anota√ß√µes internas sobre o usu√°rio. |

### 3. `events`
Tabela para todos os eventos da igreja, como cultos, confer√™ncias e reuni√µes.

| Coluna | Tipo | Descri√ß√£o |
| :--- | :--- | :--- |
| `id` | `UUID` | Chave prim√°ria do evento. |
| `titulo` | `VARCHAR(200)` | T√≠tulo do evento. |
| `descricao` | `TEXT` | Descri√ß√£o detalhada do evento. |
| `data_inicio` | `TIMESTAMPTZ` | Data e hora de in√≠cio do evento. |
| `data_fim` | `TIMESTAMPTZ` | Data e hora de t√©rmino do evento. |
| `local` | `VARCHAR(200)` | Local de realiza√ß√£o do evento. |
| `publico` | `BOOLEAN` | Se o evento √© vis√≠vel para todos (`true`) ou apenas para membros (`false`). |
| `created_by` | `UUID` | ID do usu√°rio que criou o evento. |

### 4. `members`
Registra o status de membresia de um usu√°rio na igreja.

| Coluna | Tipo | Descri√ß√£o |
| :--- | :--- | :--- |
| `id` | `UUID` | Chave prim√°ria. |
| `user_id` | `UUID` | ID do usu√°rio (referencia `users.id`). |
| `tipo_membro` | `VARCHAR(30)` | Categoria do membro (`efetivo`, `congregado`, etc.). |
| `data_ingresso`| `DATE` | Data em que o usu√°rio se tornou membro. |
| `status` | `VARCHAR(20)` | Status da membresia (`ativo`, `inativo`, etc.). |
| `batizado` | `BOOLEAN` | Indica se o membro √© batizado. |

### 5. `ministries`
Armazena informa√ß√µes sobre os minist√©rios da igreja.

| Coluna | Tipo | Descri√ß√£o |
| :--- | :--- | :--- |
| `id` | `UUID` | Chave prim√°ria do minist√©rio. |
| `nome` | `VARCHAR(100)` | Nome do minist√©rio (√∫nico). |
| `descricao` | `TEXT` | Descri√ß√£o das atividades do minist√©rio. |
| `lider_id` | `UUID` | ID do usu√°rio l√≠der do minist√©rio. |
| `vice_lider_id`| `UUID` | ID do usu√°rio vice-l√≠der. |
| `ativo` | `BOOLEAN` | Indica se o minist√©rio est√° ativo. |

### 6. `ministry_members`
Tabela de associa√ß√£o que conecta usu√°rios aos minist√©rios.

| Coluna | Tipo | Descri√ß√£o |
| :--- | :--- | :--- |
| `id` | `UUID` | Chave prim√°ria. |
| `ministry_id` | `UUID` | ID do minist√©rio. |
| `user_id` | `UUID` | ID do usu√°rio membro. |
| `cargo` | `VARCHAR(50)` | Cargo do membro no minist√©rio. |
| `ativo` | `BOOLEAN` | Indica se a participa√ß√£o est√° ativa. |

### 7. `donations`
Registro de todas as doa√ß√µes financeiras (d√≠zimos, ofertas, etc.).

| Coluna | Tipo | Descri√ß√£o |
| :--- | :--- | :--- |
| `id` | `UUID` | Chave prim√°ria da doa√ß√£o. |
| `user_id` | `UUID` | ID do doador (pode ser nulo para doa√ß√µes an√¥nimas). |
| `valor` | `DECIMAL(10,2)`| Valor da doa√ß√£o. |
| `tipo` | `VARCHAR(30)` | Tipo de doa√ß√£o (`dizimo`, `oferta`, `missoes`, etc.). |
| `data_doacao` | `DATE` | Data em que a doa√ß√£o foi realizada. |
| `anonima` | `BOOLEAN` | Se a doa√ß√£o deve ser registrada como an√¥nima. |

### 8. `event_registrations`
Gerencia as inscri√ß√µes dos usu√°rios nos eventos.

| Coluna | Tipo | Descri√ß√£o |
| :--- | :--- | :--- |
| `id` | `UUID` | Chave prim√°ria da inscri√ß√£o. |
| `event_id` | `UUID` | ID do evento. |
| `user_id` | `UUID` | ID do usu√°rio inscrito. |
| `status` | `VARCHAR(20)` | Status da inscri√ß√£o (`inscrito`, `confirmado`, `cancelado`). |

### 9. `notifications`
Armazena notifica√ß√µes destinadas aos usu√°rios.

| Coluna | Tipo | Descri√ß√£o |
| :--- | :--- | :--- |
| `id` | `UUID` | Chave prim√°ria. |
| `user_id` | `UUID` | ID do usu√°rio que receber√° a notifica√ß√£o. |
| `titulo` | `VARCHAR(200)` | T√≠tulo da notifica√ß√£o. |
| `mensagem` | `TEXT` | Conte√∫do da notifica√ß√£o. |
| `lida` | `BOOLEAN` | Indica se o usu√°rio j√° leu a notifica√ß√£o. |
| `url_acao` | `TEXT` | URL para onde o usu√°rio √© redirecionado ao clicar. |

---

## üîê Seguran√ßa (Row Level Security - RLS)

O arquivo `04_row_level_security_PRODU√áAO.sql` implementa uma camada de seguran√ßa robusta para garantir que os usu√°rios acessem apenas os dados que lhes s√£o permitidos.

### Principais Pol√≠ticas:
- **`users`**:
  - Usu√°rios s√≥ podem ver e editar seu pr√≥prio perfil.
  - `admin` e `pastor` podem ver todos os usu√°rios.
  - `leader` pode ver os membros dos seus minist√©rios.
- **`events`**:
  - Eventos marcados como `publico = true` s√£o vis√≠veis para qualquer usu√°rio autenticado.
  - Membros da igreja (`member`, `leader`, `pastor`, `admin`) podem ver todos os eventos.
- **`donations`**:
  - Usu√°rios podem ver apenas suas pr√≥prias doa√ß√µes.
  - `admin` e `pastor` podem visualizar todas as doa√ß√µes para fins de relat√≥rio.
- **`ministries`**:
  - `leader` pode gerenciar os membros e informa√ß√µes do seu pr√≥prio minist√©rio.
  - `admin` e `pastor` t√™m acesso para gerenciar todos os minist√©rios.
- **`notifications`**:
  - Um usu√°rio pode ver apenas as notifica√ß√µes destinadas a ele.

---

## ‚öôÔ∏è Fun√ß√µes e Gatilhos

O arquivo `03_funcoes_gatilhos.sql` adiciona automa√ß√£o e l√≥gica de neg√≥cios diretamente no banco de dados.

### Fun√ß√µes Not√°veis:
- **`handle_new_user()`**: Cria automaticamente um registro na tabela `public.users` quando um novo usu√°rio se cadastra no `auth.users`.
- **`validate_event_schedule()`**: Previne que dois eventos sejam agendados no mesmo local e hor√°rio, evitando conflitos.
- **`validate_event_capacity()`**: Impede novas inscri√ß√µes em eventos que j√° atingiram a capacidade m√°xima.
- **`get_donation_stats()`**: Fun√ß√£o para gerar relat√≥rios e estat√≠sticas sobre doa√ß√µes em um determinado per√≠odo.
- **`get_upcoming_events()`**: Retorna uma lista de eventos futuros para exibi√ß√£o no frontend.

### Gatilhos:
- **`update_updated_at_column()`**: Um gatilho √© aplicado a todas as tabelas para atualizar automaticamente o campo `updated_at` em qualquer modifica√ß√£o.
- **Valida√ß√£o de Eventos**: Gatilhos que disparam as fun√ß√µes `validate_event_schedule` e `validate_event_capacity` durante inser√ß√µes ou atualiza√ß√µes.

---

## üöÄ √çndices de Performance

O arquivo `02_indices_performance.sql` cria √≠ndices para acelerar as consultas mais comuns.

- **√çndices de Chave Estrangeira**: Em colunas como `user_id`, `event_id`, `ministry_id`, etc.
- **√çndices em Datas**: Em campos como `data_inicio` (eventos) e `data_doacao` (doa√ß√µes) para otimizar filtros por per√≠odo.
- **√çndices de Texto (GIN/TRGM)**: Em campos como `nome` e `titulo` para permitir buscas por similaridade de texto de forma eficiente.
- **√çndices Compostos**: Para consultas complexas que filtram por m√∫ltiplos campos simultaneamente (ex: `status` e `tipo` de membro).

---

## üß™ Dados de Exemplo

O arquivo `05_dados_exemplo.sql` (atualmente vazio) √© o local designado para inserir dados de teste, como:
- Usu√°rios com diferentes perfis (`admin`, `pastor`, `leader`, `member`).
- Minist√©rios e eventos de exemplo.
- Doa√ß√µes e inscri√ß√µes para popular relat√≥rios e pain√©is.
