#!/bin/bash

# Script de Deploy - CCCP API
# Uso: ./scripts/deploy.sh [production|staging]

set -e

ENVIRONMENT=${1:-staging}
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
BACKUP_DIR="/backups"
LOG_FILE="deploy_${TIMESTAMP}.log"

echo "üöÄ Iniciando deploy da CCCP API - Ambiente: $ENVIRONMENT"

# Fun√ß√£o para logging
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# Fun√ß√£o para verificar pr√©-requisitos
check_prerequisites() {
    log "Verificando pr√©-requisitos..."
    
    # Verificar se Docker est√° instalado
    if ! command -v docker &> /dev/null; then
        log "‚ùå Docker n√£o encontrado. Instale o Docker primeiro."
        exit 1
    fi
    
    # Verificar se Docker Compose est√° instalado
    if ! command -v docker-compose &> /dev/null && ! docker compose version &> /dev/null; then
        log "‚ùå Docker Compose n√£o encontrado. Instale o Docker Compose primeiro."
        exit 1
    fi
    
    # Verificar se arquivo .env existe
    if [ ! -f ".env" ]; then
        log "‚ùå Arquivo .env n√£o encontrado. Copie .env.example para .env e configure."
        exit 1
    fi
    
    log "‚úÖ Pr√©-requisitos verificados"
}

# Fun√ß√£o para backup
backup_current() {
    log "Criando backup do estado atual..."
    
    mkdir -p "$BACKUP_DIR/$TIMESTAMP"
    
    # Backup do banco de dados (se aplic√°vel)
    if [ "$ENVIRONMENT" = "production" ]; then
        log "Executando backup do banco de dados..."
        # Aqui voc√™ pode adicionar l√≥gica espec√≠fica de backup do Supabase
        # curl -X POST "https://api.supabase.com/v1/projects/${SUPABASE_PROJECT_ID}/database/backups" \
        #   -H "Authorization: Bearer ${SUPABASE_SERVICE_KEY}"
    fi
    
    # Backup dos volumes Docker
    docker-compose down --volumes --remove-orphans 2>/dev/null || true
    
    log "‚úÖ Backup conclu√≠do: $BACKUP_DIR/$TIMESTAMP"
}

# Fun√ß√£o para build das imagens
build_images() {
    log "Construindo imagens Docker..."
    
    # Build sem cache para garantir atualiza√ß√µes
    docker-compose build --no-cache --parallel
    
    # Remover imagens antigas n√£o utilizadas
    docker image prune -f
    
    log "‚úÖ Imagens constru√≠das com sucesso"
}

# Fun√ß√£o para deploy
deploy() {
    log "Iniciando deploy..."
    
    # Parar servi√ßos antigos
    docker-compose down --remove-orphans
    
    # Iniciar novos servi√ßos
    if [ "$ENVIRONMENT" = "production" ]; then
        docker-compose --profile production up -d
    else
        docker-compose up -d
    fi
    
    log "‚úÖ Servi√ßos iniciados"
}

# Fun√ß√£o para verificar sa√∫de dos servi√ßos
health_check() {
    log "Verificando sa√∫de dos servi√ßos..."
    
    # Aguardar servi√ßos iniciarem
    sleep 30
    
    # Verificar API
    API_URL="http://localhost:4444"
    if curl -f -s "$API_URL/health" > /dev/null; then
        log "‚úÖ API est√° saud√°vel"
    else
        log "‚ùå API n√£o est√° respondendo"
        show_logs
        exit 1
    fi
    
    # Verificar Redis
    if docker-compose exec -T redis redis-cli ping | grep -q "PONG"; then
        log "‚úÖ Redis est√° saud√°vel"
    else
        log "‚ùå Redis n√£o est√° respondendo"
        show_logs
        exit 1
    fi
    
    log "‚úÖ Todos os servi√ßos est√£o saud√°veis"
}

# Fun√ß√£o para mostrar logs em caso de erro
show_logs() {
    log "Mostrando logs dos servi√ßos..."
    docker-compose logs --tail=50
}

# Fun√ß√£o para rollback
rollback() {
    log "‚ùå Deploy falhou. Iniciando rollback..."
    
    docker-compose down --remove-orphans
    
    # Aqui voc√™ pode implementar l√≥gica de rollback espec√≠fica
    # Por exemplo, restaurar backup anterior
    
    log "Rollback conclu√≠do. Verifique os logs para identificar o problema."
    exit 1
}

# Fun√ß√£o principal
main() {
    # Trap para rollback em caso de erro
    trap rollback ERR
    
    check_prerequisites
    
    if [ "$ENVIRONMENT" = "production" ]; then
        backup_current
    fi
    
    build_images
    deploy
    health_check
    
    log "üéâ Deploy conclu√≠do com sucesso!"
    log "API dispon√≠vel em: http://localhost:4444"
    log "Health check: http://localhost:4444/health"
    
    # Limpar logs antigos (manter √∫ltimos 10)
    find . -name "deploy_*.log" -type f | sort -r | tail -n +11 | xargs rm -f 2>/dev/null || true
}

# Executar fun√ß√£o principal
main