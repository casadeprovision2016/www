#!/bin/bash

# Script de Health Check - CCCP API
# Uso: ./scripts/health-check.sh

API_URL="${API_URL:-http://localhost:4000}"
REDIS_CONTAINER="${REDIS_CONTAINER:-cccp_redis_1}"

echo "üîç Verificando sa√∫de dos servi√ßos CCCP..."

# Fun√ß√£o para colorir output
red() { echo -e "\033[31m$1\033[0m"; }
green() { echo -e "\033[32m$1\033[0m"; }
yellow() { echo -e "\033[33m$1\033[0m"; }

# Fun√ß√£o para testar API
check_api() {
    echo -n "üîç Testando API... "
    
    if response=$(curl -f -s -w "%{http_code}" "$API_URL/health" -o /tmp/health_response); then
        if [ "$response" = "200" ]; then
            green "‚úÖ API est√° saud√°vel"
            
            # Mostrar detalhes da resposta
            echo "   Detalhes:"
            cat /tmp/health_response | jq '.' 2>/dev/null || cat /tmp/health_response
            echo
            return 0
        else
            red "‚ùå API retornou c√≥digo $response"
            return 1
        fi
    else
        red "‚ùå API n√£o est√° respondendo"
        return 1
    fi
}

# Fun√ß√£o para testar Redis
check_redis() {
    echo -n "üîç Testando Redis... "
    
    if docker-compose exec -T redis redis-cli ping 2>/dev/null | grep -q "PONG"; then
        green "‚úÖ Redis est√° saud√°vel"
        
        # Mostrar informa√ß√µes do Redis
        echo "   Detalhes:"
        docker-compose exec -T redis redis-cli info server | grep "redis_version\|uptime_in_seconds" | sed 's/^/   /'
        return 0
    else
        red "‚ùå Redis n√£o est√° respondendo"
        return 1
    fi
}

# Fun√ß√£o para verificar containers Docker
check_containers() {
    echo "üîç Verificando containers Docker..."
    
    containers=$(docker-compose ps --format "table {{.Name}}\t{{.State}}\t{{.Status}}")
    echo "$containers"
    
    # Verificar se todos os containers est√£o rodando
    if docker-compose ps | grep -q "Exit"; then
        red "‚ùå Alguns containers n√£o est√£o rodando"
        return 1
    else
        green "‚úÖ Todos os containers est√£o rodando"
        return 0
    fi
}

# Fun√ß√£o para verificar recursos do sistema
check_system_resources() {
    echo "üîç Verificando recursos do sistema..."
    
    # Verificar uso de mem√≥ria
    memory_usage=$(free | grep Mem | awk '{printf "%.1f", $3/$2 * 100.0}')
    echo "   Uso de mem√≥ria: ${memory_usage}%"
    
    if (( $(echo "$memory_usage > 90" | bc -l) )); then
        yellow "‚ö†Ô∏è  Alto uso de mem√≥ria"
    fi
    
    # Verificar uso de disco
    disk_usage=$(df / | awk 'NR==2 {print $5}' | sed 's/%//')
    echo "   Uso de disco: ${disk_usage}%"
    
    if [ "$disk_usage" -gt 90 ]; then
        yellow "‚ö†Ô∏è  Alto uso de disco"
    fi
    
    # Verificar carga do sistema
    load_avg=$(uptime | awk -F'load average:' '{print $2}' | cut -d, -f1 | xargs)
    echo "   Carga m√©dia: $load_avg"
}

# Fun√ß√£o para verificar logs recentes
check_recent_logs() {
    echo "üîç Verificando logs recentes de erros..."
    
    # Procurar por erros nos √∫ltimos 5 minutos
    if docker-compose logs --since="5m" | grep -i "error\|exception\|fatal" >/dev/null 2>&1; then
        yellow "‚ö†Ô∏è  Erros encontrados nos logs recentes:"
        docker-compose logs --since="5m" | grep -i "error\|exception\|fatal" | tail -5 | sed 's/^/   /'
    else
        green "‚úÖ Nenhum erro recente encontrado nos logs"
    fi
}

# Fun√ß√£o para testar endpoints principais
test_endpoints() {
    echo "üîç Testando endpoints principais..."
    
    endpoints=(
        "/health"
        "/api/events/stats"
        "/api/members/stats"
        "/api/donations/stats"
    )
    
    for endpoint in "${endpoints[@]}"; do
        echo -n "   Testando $endpoint... "
        
        if curl -f -s "$API_URL$endpoint" > /dev/null; then
            green "‚úÖ"
        else
            red "‚ùå"
        fi
    done
}

# Fun√ß√£o principal
main() {
    echo "========================================="
    echo "      CCCP API Health Check"
    echo "========================================="
    echo
    
    # Contador de falhas
    failures=0
    
    # Executar verifica√ß√µes
    check_containers || ((failures++))
    echo
    
    check_api || ((failures++))
    echo
    
    check_redis || ((failures++))
    echo
    
    test_endpoints || ((failures++))
    echo
    
    check_system_resources
    echo
    
    check_recent_logs
    echo
    
    # Resultado final
    echo "========================================="
    if [ $failures -eq 0 ]; then
        green "üéâ Todos os servi√ßos est√£o saud√°veis!"
        echo "   Timestamp: $(date)"
        echo "   Uptime: $(uptime | awk -F'up ' '{print $2}' | awk -F',' '{print $1}')"
        exit 0
    else
        red "‚ùå $failures verifica√ß√µes falharam"
        echo "   Verifique os logs para mais detalhes:"
        echo "   docker-compose logs --tail=50"
        exit 1
    fi
}

# Executar fun√ß√£o principal
main